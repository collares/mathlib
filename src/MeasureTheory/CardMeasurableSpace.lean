/-
Copyright (c) 2022 SÃ©bastien GouÃ«zel. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: SÃ©bastien GouÃ«zel, Violeta HernÃ¡ndez Palacios
-/
import Mathbin.MeasureTheory.MeasurableSpaceDef
import Mathbin.SetTheory.Continuum
import Mathbin.SetTheory.Cofinality

/-!
# Cardinal of sigma-algebras

If a sigma-algebra is generated by a set of sets `s`, then the cardinality of the sigma-algebra is
bounded by `(max (#s) 2) ^ Ï‰`. This is stated in `measurable_space.cardinal_generate_measurable_le`
and `measurable_space.cardinal_measurable_set_le`.

In particular, if `#s â‰¤ ğ” `, then the generated sigma-algebra has cardinality at most `ğ” `, see
`measurable_space.cardinal_measurable_set_le_continuum`.

For the proof, we rely on an explicit inductive construction of the sigma-algebra generated by
`s` (instead of the inductive predicate `generate_measurable`). This transfinite inductive
construction is parameterized by an ordinal `< Ï‰â‚`, and the cardinality bound is preserved along
each step of the construction.
-/


universe u

variable {Î± : Type u}

open_locale Cardinal

open Cardinal Set

-- mathport name: Â«exprÏ‰â‚Â»
local notation "Ï‰â‚" => (aleph 1 : Cardinal.{u}).ord.out.Î±

namespace MeasurableSpace

/-- Transfinite induction construction of the sigma-algebra generated by a set of sets `s`. At each
step, we add all elements of `s`, the empty set, the complements of already constructed sets, and
countable unions of already constructed sets. We index this construction by an ordinal `< Ï‰â‚`, as
this will be enough to generate all sets in the sigma-algebra. -/
def GenerateMeasurableRec (s : Set (Set Î±)) : Ï‰â‚ â†’ Set (Set Î±)
  | i =>
    let S := â‹ƒ j : { j // j < i }, generate_measurable_rec j.1
    s âˆª {âˆ…} âˆª compl '' S âˆª Set.Range fun f : â„• â†’ S => â‹ƒ n, (f n).1

/-- At each step of the inductive construction, the cardinality bound `â‰¤ (max (#s) 2) ^ Ï‰`
holds. -/
theorem cardinal_generate_measurable_rec_le (s : Set (Set Î±)) (i : Ï‰â‚) :
    # (GenerateMeasurableRec s i) â‰¤ max (# s) 2 ^ omega.{u} := by
  apply (aleph 1).ord.out.wo.wf.induction i
  intro i IH
  have A := omega_le_aleph 1
  have B : aleph 1 â‰¤ max (# s) 2 ^ omega.{u} := aleph_one_le_continuum.trans (power_le_power_right (le_max_rightâ‚“ _ _))
  have C : omega.{u} â‰¤ max (# s) 2 ^ omega.{u} := A.trans B
  have J : # (â‹ƒ j : { j // j < i }, generate_measurable_rec s j.1) â‰¤ max (# s) 2 ^ omega.{u} := by
    apply (mk_Union_le _).trans
    have D : # { j // j < i } â‰¤ aleph 1 := (mk_subtype_le _).trans (le_of_eqâ‚“ (aleph 1).mk_ord_out)
    have E :
      (Cardinal.sup.{u, u} fun j : { j // j < i } => # (generate_measurable_rec s j.1)) â‰¤ max (# s) 2 ^ omega.{u} :=
      Cardinal.sup_le.2 fun âŸ¨j, hjâŸ© => IH j hj
    apply (mul_le_mul' D E).trans
    rw [mul_eq_max A C]
    exact max_leâ‚“ B le_rfl
  rw [generate_measurable_rec]
  apply_rules [(mk_union_le _ _).trans, add_le_of_le C, mk_image_le.trans]
  Â· exact (le_max_leftâ‚“ _ _).trans (self_le_power _ one_lt_omega.le)
    
  Â· rw [mk_singleton]
    exact one_lt_omega.le.trans C
    
  Â· apply mk_range_le.trans
    simp only [mk_pi, Subtype.val_eq_coe, prod_const, lift_uzero, mk_denumerable, lift_omega]
    have := @power_le_power_right _ _ omega.{u} J
    rwa [â† power_mul, omega_mul_omega] at this
    

theorem cardinal_Union_generate_measurable_rec_le (s : Set (Set Î±)) :
    # (â‹ƒ i, GenerateMeasurableRec s i) â‰¤ max (# s) 2 ^ omega.{u} := by
  apply (mk_Union_le _).trans
  rw [(aleph 1).mk_ord_out]
  refine'
    le_transâ‚“ (mul_le_mul' aleph_one_le_continuum (Cardinal.sup_le.2 fun i => cardinal_generate_measurable_rec_le s i))
      _
  have := power_le_power_right (le_max_rightâ‚“ (# s) 2)
  rw [mul_eq_max omega_le_continuum (omega_le_continuum.trans this)]
  exact max_leâ‚“ this le_rfl

/-- A set in the sigma-algebra generated by a set of sets `s` is constructed at some step of the
transfinite induction defining `generate_measurable_rec`.
The other inclusion is also true, but not proved here as it is not needed for the cardinality
bounds.-/
theorem generate_measurable_subset_rec (s : Set (Set Î±)) â¦ƒt : Set Î±â¦„ (ht : GenerateMeasurable s t) :
    t âˆˆ â‹ƒ i, GenerateMeasurableRec s i := by
  inhabit Ï‰â‚
  induction' ht with u hu u hu IH f hf IH
  Â· refine' mem_Union.2 âŸ¨default, _âŸ©
    rw [generate_measurable_rec]
    simp only [hu, mem_union_eq, true_orâ‚“]
    
  Â· refine' mem_Union.2 âŸ¨default, _âŸ©
    rw [generate_measurable_rec]
    simp only [union_singleton, mem_union_eq, mem_insert_iff, eq_self_iff_true, true_orâ‚“]
    
  Â· rcases mem_Union.1 IH with âŸ¨i, hiâŸ©
    obtain âŸ¨j, hjâŸ© : âˆƒ j, i < j :=
      Ordinal.has_succ_of_type_succ_lt
        (by
          rw [Ordinal.type_lt]
          exact (ord_aleph_is_limit 1).2)
        _
    apply mem_Union.2 âŸ¨j, _âŸ©
    rw [generate_measurable_rec]
    have : âˆƒ a, a < j âˆ§ u âˆˆ generate_measurable_rec s a := âŸ¨i, hj, hiâŸ©
    simp [this]
    
  Â· have : âˆ€ n, âˆƒ i, f n âˆˆ generate_measurable_rec s i := fun n => by
      simpa using IH n
    choose I hI using this
    obtain âŸ¨j, hjâŸ© : âˆƒ j, âˆ€ k, k âˆˆ range I â†’ k < j := by
      apply Ordinal.lt_cof_type
      simp only [is_regular_aleph_one.2, mk_singleton, Ordinal.type_lt]
      have : # (range I) = lift.{0} (# (range I)) := by
        simp only [lift_uzero]
      rw [this]
      apply mk_range_le_lift.trans_lt _
      simp [omega_lt_aleph_one]
    apply mem_Union.2 âŸ¨j, _âŸ©
    rw [generate_measurable_rec]
    have : âˆƒ g : â„• â†’ â†¥(â‹ƒ i : { i // i < j }, generate_measurable_rec s i.1), (â‹ƒ n : â„•, â†‘(g n)) = â‹ƒ n, f n := by
      refine' âŸ¨fun n => âŸ¨f n, _âŸ©, rflâŸ©
      exact mem_Union.2 âŸ¨âŸ¨I n, hj (I n) (mem_range_self _)âŸ©, hI nâŸ©
    simp [this]
    

/-- If a sigma-algebra is generated by a set of sets `s`, then the sigma
algebra has cardinality at most `(max (#s) 2) ^ Ï‰`. -/
theorem cardinal_generate_measurable_le (s : Set (Set Î±)) :
    # { t | GenerateMeasurable s t } â‰¤ max (# s) 2 ^ omega.{u} :=
  (mk_subtype_le_of_subset (generate_measurable_subset_rec s)).trans (cardinal_Union_generate_measurable_rec_le s)

/-- If a sigma-algebra is generated by a set of sets `s`, then the sigma
algebra has cardinality at most `(max (#s) 2) ^ Ï‰`. -/
theorem cardinal_measurable_set_le (s : Set (Set Î±)) :
    # { t | @MeasurableSet Î± (generateFrom s) t } â‰¤ max (# s) 2 ^ omega.{u} :=
  cardinal_generate_measurable_le s

/-- If a sigma-algebra is generated by a set of sets `s` with cardinality at most the continuum,
then the sigma algebra has the same cardinality bound. -/
theorem cardinal_generate_measurable_le_continuum {s : Set (Set Î±)} (hs : # s â‰¤ ğ” ) :
    # { t | GenerateMeasurable s t } â‰¤ ğ”  :=
  calc
    # { t | GenerateMeasurable s t } â‰¤ max (# s) 2 ^ omega.{u} := cardinal_generate_measurable_le s
    _ â‰¤ ğ”  ^ omega.{u} := by
      exact_mod_cast power_le_power_right (max_leâ‚“ hs (nat_lt_continuum 2).le)
    _ = ğ”  := continuum_power_omega
    

/-- If a sigma-algebra is generated by a set of sets `s` with cardinality at most the continuum,
then the sigma algebra has the same cardinality bound. -/
theorem cardinal_measurable_set_le_continuum {s : Set (Set Î±)} (hs : # s â‰¤ ğ” ) :
    # { t | @MeasurableSet Î± (generateFrom s) t } â‰¤ ğ”  :=
  cardinal_generate_measurable_le_continuum hs

end MeasurableSpace

